<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TradeTrakR Terminal | Dashboard</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  
  <!-- Emergency redirect fix: Catch any old paywall.html redirects -->
  <script>
    // If somehow redirected to paywall.html, immediately redirect to correct page
    if (window.location.pathname === '/paywall.html' || window.location.pathname.includes('/paywall.html')) {
      window.location.replace('/onboarding-paywall.html');
    }
    
    // IMMEDIATE NEW USER REDIRECT: Catch OAuth callbacks for new users
    // Run this immediately, before Supabase even loads, to prevent any flash of content
    // BUT only redirect if we're absolutely sure - don't block paid users
    (async function immediateNewUserRedirect() {
      // Check if this might be an OAuth callback (has hash with session tokens)
      const hasAuthHash = window.location.hash && (
        window.location.hash.includes('access_token') || 
        window.location.hash.includes('type=recovery')
      );
      
      if (hasAuthHash) {
        // Wait for Supabase to process the session
        await new Promise(resolve => setTimeout(resolve, 800));
        
        // Now check if user exists and if they're new
        if (typeof window.supabaseClient !== 'undefined') {
          try {
            const supabase = window.supabaseClient;
            const { data: { user } } = await supabase.auth.getUser();
            
            if (user) {
              const { data: profile } = await supabase
                .from('profiles')
                .select('onboarding_complete, subscription_tier')
                .eq('id', user.id)
                .single();
              
              // Only redirect if:
              // 1. Profile doesn't exist (new user), OR
              // 2. User hasn't completed onboarding AND doesn't have paid subscription
              // Don't redirect paid users even if onboarding isn't complete (edge case handling)
              if (!profile) {
                console.log('No profile found on download page - redirecting to onboarding');
                window.location.replace(window.location.origin + '/onboarding.html');
                return;
              }
              
              if (!profile.onboarding_complete && profile.subscription_tier !== 'paid') {
                console.log('New user (no onboarding, not paid) detected on download page - redirecting to onboarding');
                window.location.replace(window.location.origin + '/onboarding.html');
                return;
              }
              
              // If we get here, user has profile and either completed onboarding or has paid subscription
              // Let the main auth guard handle the rest
            }
          } catch (error) {
            console.error('Error in immediate new user redirect check:', error);
            // Don't redirect on error - let main auth guard handle it
          }
        }
      }
    })();
    
    // IMMEDIATE AUTH CHECK: Start visible and check subscription quickly
    // Don't hide page - only redirect if needed
    document.addEventListener('DOMContentLoaded', function() {
      // Quick check to prevent unnecessary hiding
      // The main auth guard will handle redirects
      console.log('Page loaded, checking auth status...');
    });
  </script>
  
  <style>
    /* Start page visible, hide only if auth check fails */
    body {
      visibility: visible;
      opacity: 1;
      transition: opacity 0.3s ease;
    }
    body.auth-hiding {
      visibility: hidden;
      opacity: 0;
    }
    body.auth-verified {
      visibility: visible;
      opacity: 1;
    }
  </style>

  <!-- Fonts: Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600;700&display=swap"
    rel="stylesheet">

  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabaseClient.js"></script>

  <style>
    /* THEME VARIABLES - OBSIDIAN */
    :root {
      --bg-obsidian: #050505;
      --bg-void: #000000;
      --bg-glass: rgba(20, 20, 25, 0.7);
      --bg-glass-hover: rgba(30, 30, 35, 0.9);

      --accent-cyan: #00f3ff;
      --accent-violet: #bd00ff;
      --accent-blue: #2d5af5;
      --accent-success: #0aff68;
      --accent-danger: #ff3366;

      --text-primary: #ffffff;
      --text-secondary: #94a3b8;
      --text-dim: #475569;

      --border-subtle: rgba(255, 255, 255, 0.08);
      --border-glow: rgba(0, 243, 255, 0.3);

      --font-main: 'Inter', sans-serif;

      --shadow-neon: 0 0 20px rgba(0, 243, 255, 0.15);
      --shadow-card: 0 10px 30px -10px rgba(0, 0, 0, 0.8);
    }

    /* GLOBAL RESET & BASE */
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: var(--font-main);
      background-color: var(--bg-obsidian);
      color: var(--text-primary);
      line-height: 1.6;
      font-weight: 300;
      overflow-x: hidden;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Background Tech Grid */
    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image:
        linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
      background-size: 50px 50px;
      z-index: -2;
      pointer-events: none;
    }

    body::after {
      content: "";
      position: fixed;
      top: -20%;
      left: -20%;
      width: 140%;
      height: 140%;
      background:
        radial-gradient(circle at 50% 0%, rgba(45, 90, 245, 0.08), transparent 40%),
        radial-gradient(circle at 80% 50%, rgba(189, 0, 255, 0.05), transparent 40%);
      z-index: -1;
      pointer-events: none;
    }

    a {
      text-decoration: none;
      color: inherit;
      transition: all 0.3s ease;
    }

    .container {
      width: 90%;
      max-width: 1200px;
      margin: auto;
      position: relative;
    }

    /* LIVE TICKER */
    .market-ticker-wrap {
      width: 100%;
      background: rgba(0, 0, 0, 0.8);
      border-bottom: 1px solid var(--border-subtle);
      overflow: hidden;
      white-space: nowrap;
      position: relative;
      z-index: 100;
      height: 36px;
      display: flex;
      align-items: center;
    }

    .market-ticker {
      display: inline-block;
      animation: ticker 30s linear infinite;
      padding-left: 100%;
    }

    .ticker-item {
      display: inline-block;
      padding: 0 2rem;
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .ticker-up {
      color: var(--accent-success);
      margin-left: 5px;
    }

    .ticker-down {
      color: var(--accent-danger);
      margin-left: 5px;
    }

    @keyframes ticker {
      0% {
        transform: translate3d(0, 0, 0);
      }

      100% {
        transform: translate3d(-100%, 0, 0);
      }
    }

    /* HEADER */
    .header {
      padding: 1.5rem 0;
      border-bottom: 1px solid var(--border-subtle);
      background: rgba(5, 5, 5, 0.5);
      backdrop-filter: blur(10px);
    }

    .header-inner {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -0.03em;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo::after {
      content: '';
      width: 6px;
      height: 6px;
      background: var(--accent-cyan);
      border-radius: 50%;
      box-shadow: 0 0 10px var(--accent-cyan);
    }

    .user-controls {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .system-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.8rem;
      color: var(--accent-success);
      background: rgba(10, 255, 104, 0.1);
      padding: 6px 12px;
      border-radius: 20px;
      border: 1px solid rgba(10, 255, 104, 0.2);
    }

    .pulse-dot {
      width: 6px;
      height: 6px;
      background: currentColor;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .user-profile {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .avatar {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, #333, #111);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      border: 1px solid var(--border-subtle);
    }

    .sign-out {
      font-size: 0.9rem;
      color: var(--text-secondary);
      cursor: pointer;
    }

    .sign-out:hover {
      color: var(--text-primary);
    }

    /* DASHBOARD CONTENT */
    .dashboard-main {
      padding: 3rem 0;
      flex: 1;
    }

    .welcome-area {
      margin-bottom: 3rem;
    }

    .welcome-title {
      font-size: 2.5rem;
      font-weight: 700;
      margin: 0 0 0.5rem 0;
      background: linear-gradient(90deg, #fff, var(--text-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .market-status {
      font-size: 1rem;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-dim);
    }

    .status-indicator.open {
      background: var(--accent-success);
      box-shadow: 0 0 10px var(--accent-success);
    }

    /* STATS GRID */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-bottom: 3rem;
    }

    .stat-card {
      background: var(--bg-glass);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      padding: 1.5rem;
      backdrop-filter: blur(12px);
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, var(--accent-cyan), transparent);
      opacity: 0.5;
    }

    .stat-label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-dim);
      margin-bottom: 0.5rem;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: #fff;
    }

    .stat-sub {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-top: 5px;
    }

    /* COUNTDOWN */
    .countdown-timer {
      font-family: 'Courier New', monospace;
      letter-spacing: -1px;
    }

    /* ACTION GRID */
    .actions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap: 1.5rem;
      margin-bottom: 3rem;
    }

    .action-card {
      display: flex;
      align-items: center;
      gap: 1.25rem;
      padding: 1.5rem;
      height: 120px;
      background: var(--bg-glass);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      position: relative;
      overflow: hidden;
    }

    .action-card:hover {
      transform: translateY(-5px);
      border-color: var(--accent-cyan);
      background: var(--bg-glass-hover);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    .action-card:hover .icon-box {
      color: var(--accent-cyan);
      border-color: var(--accent-cyan);
      box-shadow: 0 0 15px rgba(0, 243, 255, 0.2);
    }

    .icon-box {
      flex-shrink: 0;
      width: 60px;
      height: 60px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      color: var(--text-secondary);
      transition: all 0.3s ease;
    }

    .action-text {
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .action-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #fff;
      margin-bottom: 4px;
    }

    .action-desc {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    /* CHANGELOG */
    .changelog-section {
      background: rgba(10, 10, 15, 0.5);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      padding: 2rem;
    }

    .changelog-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid var(--border-subtle);
      padding-bottom: 1rem;
    }

    .changelog-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: #fff;
    }

    .version-tag {
      background: rgba(255, 255, 255, 0.1);
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-family: monospace;
    }

    .update-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .update-item {
      display: flex;
      gap: 15px;
      margin-bottom: 1rem;
    }

    .update-icon {
      color: var(--accent-success);
      font-weight: bold;
    }

    .update-content {
      font-size: 0.95rem;
      color: var(--text-secondary);
    }

    @keyframes pulse {
      0% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }

      100% {
        opacity: 1;
      }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header-inner {
        flex-direction: column;
        gap: 1rem;
      }

      .stats-grid,
      .actions-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>

  <!-- Live Market Ticker -->
  <div class="market-ticker-wrap">
    <div class="market-ticker">
      <span class="ticker-item">ES <span class="ticker-up">▲ 4450.00</span></span>
      <span class="ticker-item">NQ <span class="ticker-up">▲ 15230.50</span></span>
      <span class="ticker-item">RTY <span class="ticker-down">▼ 1845.20</span></span>
      <span class="ticker-item">CL <span class="ticker-up">▲ 82.40</span></span>
      <span class="ticker-item">GC <span class="ticker-down">▼ 1945.10</span></span>
      <span class="ticker-item">BTC <span class="ticker-up">▲ 34500.00</span></span>
      <span class="ticker-item">ETH <span class="ticker-up">▲ 1850.00</span></span>
      <span class="ticker-item">EUR/USD <span class="ticker-down">▼ 1.0540</span></span>
      <!-- Duplicate for seamless loop -->
      <span class="ticker-item">ES <span class="ticker-up">▲ 4450.00</span></span>
      <span class="ticker-item">NQ <span class="ticker-up">▲ 15230.50</span></span>
      <span class="ticker-item">RTY <span class="ticker-down">▼ 1845.20</span></span>
      <span class="ticker-item">CL <span class="ticker-up">▲ 82.40</span></span>
      <span class="ticker-item">GC <span class="ticker-down">▼ 1945.10</span></span>
      <span class="ticker-item">BTC <span class="ticker-up">▲ 34500.00</span></span>
      <span class="ticker-item">ETH <span class="ticker-up">▲ 1850.00</span></span>
      <span class="ticker-item">EUR/USD <span class="ticker-down">▼ 1.0540</span></span>
    </div>
  </div>

  <header class="header">
    <div class="container header-inner">
      <a href="index.html" class="logo">TradeTrakR</a>
      <div class="user-controls">
        <div class="system-status">
          <div class="pulse-dot"></div> Systems Operational
        </div>
        <div class="user-profile">
          <div class="avatar">TR</div>
          <span id="sign-out" class="sign-out">Sign Out</span>
        </div>
      </div>
    </div>
  </header>

  <main class="container dashboard-main">
    <div class="welcome-area">
      <h1 class="welcome-title">Welcome back, Trader</h1>
      <div class="market-status">
        <div class="status-indicator" id="market-status-dot"></div>
        <span id="market-status-text">Checking Market Status...</span>
      </div>
    </div>

    <div class="stats-grid">
      <!-- Countdown Widget -->
      <div class="stat-card">
        <div class="stat-label">Market Open In</div>
        <div class="stat-value countdown-timer" id="countdown">--:--:--</div>
        <div class="stat-sub">New York Session (09:30 EST)</div>
      </div>

      <!-- Streak Counter -->
      <div class="stat-card">
        <div class="stat-label">Journal Streak</div>
        <div class="stat-value" style="font-size: 1.5rem; color: var(--text-dim);">Coming Soon</div>
        <div class="stat-sub">Feature in development</div>
      </div>

      <!-- Daily Wisdom -->
      <div class="stat-card">
        <div class="stat-label">Daily Wisdom</div>
        <div class="stat-value" style="font-size: 1.1rem; line-height: 1.4; font-weight: 400; font-style: italic;">"The
          goal of a successful trader is to make the best trades. Money is secondary."</div>
        <div class="stat-sub">— Alexander Elder</div>
      </div>
    </div>

    <div class="actions-grid">
      <!-- Download App -->
      <a href="https://github.com/VincentLaaa/tradetrakr-releases/releases" target="_blank" class="action-card">
        <div class="icon-box">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
        </div>
        <div class="action-text">
          <div class="action-title">Download App</div>
          <div class="action-desc" id="version-text">Loading version...</div>
        </div>
      </a>

      <!-- Join Discord -->
      <a href="https://discord.gg/cfEh4MuduT" target="_blank" class="action-card">
        <div class="icon-box">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <path
              d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z">
            </path>
          </svg>
        </div>
        <div class="action-text">
          <div class="action-title">Join Discord</div>
          <div class="action-desc">Connect with funded traders</div>
        </div>
      </a>

      <!-- Coming Soon Feature -->
      <div class="action-card" style="opacity: 0.5; cursor: default;">
        <div class="icon-box">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
        </div>
        <div class="action-text">
          <div class="action-title" style="color: var(--text-dim);">Coming Soon</div>
          <div class="action-desc">New features in development</div>
        </div>
      </div>
    </div>

    <div class="changelog-section">
      <div class="changelog-header">
        <div class="changelog-title">Latest Updates</div>
        <div class="version-tag" id="version-tag">Loading...</div>
      </div>
      <ul class="update-list" id="update-list">
        <li class="update-item"><span class="update-icon">•</span> <span class="update-content">Fetching release
            notes...</span></li>
      </ul>
    </div>
  </main>

  <script src="script.js" defer></script>
  <script>
    const RELEASE_API_URL = "https://api.github.com/repos/VincentLaaa/tradetrakr-releases/releases/latest";

    // Fetch latest release from GitHub
    async function fetchLatestRelease() {
      try {
        const response = await fetch(RELEASE_API_URL, {
          headers: { Accept: "application/vnd.github+json" }
        });

        if (!response.ok) throw new Error(`Failed to fetch: ${response.status}`);

        const release = await response.json();

        // Update version in download card
        const versionText = document.getElementById('version-text');
        if (versionText) {
          const version = release.name || release.tag_name || 'Latest';
          versionText.textContent = `Get the latest version (${version})`;
        }

        // Update version tag in changelog
        const versionTag = document.getElementById('version-tag');
        if (versionTag) {
          versionTag.textContent = release.tag_name || release.name || 'Latest';
        }

        // Update changelog/release notes
        const updateList = document.getElementById('update-list');
        if (updateList && release.body) {
          updateList.innerHTML = '';

          const lines = release.body
            .split(/\r?\n/)
            .map(line => line.trim())
            .filter(line => line.length > 0 && !/^#+\s*/.test(line));

          const itemsToShow = lines.slice(0, 5);
          itemsToShow.forEach(line => {
            const li = document.createElement('li');
            li.className = 'update-item';

            const icon = document.createElement('span');
            icon.className = 'update-icon';
            icon.textContent = '+';

            const content = document.createElement('span');
            content.className = 'update-content';
            content.textContent = line.replace(/^[-*•]\s*/, '');

            li.appendChild(icon);
            li.appendChild(document.createTextNode(' '));
            li.appendChild(content);
            updateList.appendChild(li);
          });

          if (itemsToShow.length === 0) {
            const li = document.createElement('li');
            li.className = 'update-item';
            li.innerHTML = '<span class="update-icon">•</span> <span class="update-content">No release notes available</span>';
            updateList.appendChild(li);
          }
        }
      } catch (error) {
        console.error('Failed to fetch release:', error);
        // Keep loading states or show error
        const versionText = document.getElementById('version-text');
        if (versionText) versionText.textContent = 'View latest version';

        const versionTag = document.getElementById('version-tag');
        if (versionTag) versionTag.textContent = 'Latest';

        const updateList = document.getElementById('update-list');
        if (updateList) {
          updateList.innerHTML = '<li class="update-item"><span class="update-icon">!</span> <span class="update-content">Unable to fetch release notes. Visit GitHub for details.</span></li>';
        }
      }
    }

    // Session Countdown Logic
    function updateCountdown() {
      const now = new Date();
      const estTime = new Date(now.toLocaleString("en-US", { timeZone: "America/New_York" }));

      let nextOpen = new Date(estTime);
      nextOpen.setHours(9, 30, 0, 0);

      // If it's past 9:30 AM today, set for tomorrow
      if (estTime > nextOpen) {
        nextOpen.setDate(nextOpen.getDate() + 1);
      }

      // Skip weekends
      while (nextOpen.getDay() === 0 || nextOpen.getDay() === 6) {
        nextOpen.setDate(nextOpen.getDate() + 1);
      }

      const diff = nextOpen - estTime;

      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((diff % (1000 * 60)) / 1000);

      document.getElementById('countdown').textContent =
        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

      // Market Status
      const day = estTime.getDay();
      const hour = estTime.getHours();
      const minute = estTime.getMinutes();
      const timeVal = hour + minute / 60;

      const statusDot = document.getElementById('market-status-dot');
      const statusText = document.getElementById('market-status-text');

      // Simple check for NYSE hours (Mon-Fri 9:30 - 16:00)
      if (day >= 1 && day <= 5 && timeVal >= 9.5 && timeVal < 16) {
        statusDot.className = 'status-indicator open';
        statusText.textContent = 'Market is Open';
        statusText.style.color = 'var(--accent-success)';
      } else {
        statusDot.className = 'status-indicator';
        statusText.textContent = 'Market is Closed';
        statusText.style.color = 'var(--text-secondary)';
      }
    }

    // Initialize
    fetchLatestRelease();
    setInterval(updateCountdown, 1000);
    updateCountdown();
  </script>

  <script>
    // Wait for DOM and Supabase to be ready
    document.addEventListener('DOMContentLoaded', function() {
      // Wait for Supabase client to be initialized
      function waitForSupabase(callback, maxAttempts = 15) {
        let attempts = 0;
        const checkSupabase = setInterval(() => {
          attempts++;
          if (window.supabaseClient) {
            clearInterval(checkSupabase);
            callback();
          } else if (attempts >= maxAttempts) {
            clearInterval(checkSupabase);
            console.error('Supabase client not found after', maxAttempts, 'attempts');
          }
        }, 100);
      }

      waitForSupabase(() => {
        const supabase = window.supabaseClient;

        if (!supabase) {
          console.error('Supabase client not available');
          // If Supabase fails to load, show page anyway after delay (might be a CDN issue)
          setTimeout(() => {
            console.warn('Supabase unavailable - showing page anyway after delay');
            const body = document.body;
            if (body) {
              body.classList.add('auth-verified');
              body.style.visibility = 'visible';
              body.style.opacity = '1';
            }
          }, 5000);
          return;
        }

        // Ensure user profile exists (fallback if trigger doesn't fire)
        async function ensureUserProfile() {
          try {
            const { data: { user }, error: userError } = await supabase.auth.getUser();
            
            if (userError || !user) {
              console.log('No user found, skipping profile creation');
              return false;
            }

            console.log('Checking for profile for user:', user.id);

            // Check if profile exists
            const { data: profile, error: fetchError } = await supabase
              .from('profiles')
              .select('id, subscription_tier, onboarding_complete')
              .eq('id', user.id)
              .single();

            // If profile doesn't exist, create it
            if (fetchError) {
              // PGRST116 = no rows returned
              if (fetchError.code === 'PGRST116' || fetchError.message?.includes('No rows')) {
                console.log('Profile not found, creating one for user:', user.id);
                console.log('User email:', user.email);
                console.log('User metadata:', user.user_metadata);
                
                // Extract user info from auth user
                const email = user.email || user.user_metadata?.email || null;
                const fullName = user.user_metadata?.full_name || user.user_metadata?.name || null;
                const avatarUrl = user.user_metadata?.avatar_url || user.user_metadata?.picture || null;
                
                const { data: newProfile, error: insertError } = await supabase
                  .from('profiles')
                  .insert({
                    id: user.id,
                    email: email,
                    full_name: fullName,
                    avatar_url: avatarUrl,
                    subscription_tier: 'free',
                    onboarding_complete: false
                  })
                  .select()
                  .single();

                if (insertError) {
                  console.error('Error creating profile:', insertError);
                  console.error('Insert error details:', JSON.stringify(insertError, null, 2));
                  return false;
                } else {
                  console.log('Profile created successfully:', newProfile);
                  return true;
                }
              } else {
                console.error('Error checking profile:', fetchError);
                console.error('Fetch error details:', JSON.stringify(fetchError, null, 2));
                return false;
              }
            } else {
              console.log('Profile already exists:', profile);
              // Update profile with latest user metadata if missing
              const email = user.email || user.user_metadata?.email || null;
              const fullName = user.user_metadata?.full_name || user.user_metadata?.name || null;
              const avatarUrl = user.user_metadata?.avatar_url || user.user_metadata?.picture || null;
              
              if ((email && !profile.email) || (fullName && !profile.full_name) || (avatarUrl && !profile.avatar_url)) {
                console.log('Updating profile with user metadata...');
                const updates = {};
                if (email && !profile.email) updates.email = email;
                if (fullName && !profile.full_name) updates.full_name = fullName;
                if (avatarUrl && !profile.avatar_url) updates.avatar_url = avatarUrl;
                
                const { error: updateError } = await supabase
                  .from('profiles')
                  .update(updates)
                  .eq('id', user.id);
                  
                if (updateError) {
                  console.error('Error updating profile metadata:', updateError);
                } else {
                  console.log('Profile metadata updated successfully');
                }
              }
              return true;
            }
          } catch (error) {
            console.error('Error ensuring user profile:', error);
            return false;
          }
        }

        // Helper to show the page content
        function showPage() {
          const body = document.body;
          if (body) {
            body.classList.remove('auth-hiding');
            body.classList.add('auth-verified');
            body.style.visibility = 'visible';
            body.style.opacity = '1';
            console.log('✅ Page visibility restored');
          }
        }

        // Helper to hide the page content
        function hidePage() {
          const body = document.body;
          if (body) {
            body.classList.add('auth-hiding');
            body.classList.remove('auth-verified');
          }
        }

        // Ensure profile exists before checking subscription
        ensureUserProfile().then(() => {
          // 1. Auth Guard - check subscription and redirect if needed
          (async function guardDownloadPage() {
          try {
            const { data: { user }, error: userError } = await supabase.auth.getUser();

            if (userError || !user) {
              // Not signed in → send them to sign in page
              console.log('User not authenticated. Redirecting to sign in.');
              window.location.href = window.location.origin + '/signin.html';
              return;
            }

            console.log('User authenticated:', user.id);

            // Check profile (onboarding + subscription) with retry logic
            // This handles cases where license validation just updated the profile
            let profile = null;
            let lastError = null;
            
            for (let attempt = 0; attempt < 3; attempt++) {
              if (attempt > 0) {
                // Wait before retrying (1s, then 2s)
                await new Promise(resolve => setTimeout(resolve, attempt * 1000));
              }

              const { data, error } = await supabase
                .from('profiles')
                .select('subscription_tier, onboarding_complete')
                .eq('id', user.id)
                .single();

              if (!error && data) {
                profile = data;
                console.log(`Profile check attempt ${attempt + 1}:`, profile);
                // If we found a paid subscription, break early
                if (data.subscription_tier === 'paid') {
                  break;
                }
              } else {
                lastError = error;
                console.log(`Profile check attempt ${attempt + 1} failed:`, error?.message);
              }
            }

            // Handle based on profile status
            if (!profile) {
              // No profile found - redirect to onboarding (new user)
              console.log('Profile not found. Redirecting to onboarding for new users.');
              window.location.href = window.location.origin + '/onboarding.html';
              return;
            }
            
            // Check subscription tier
            if (profile.subscription_tier === 'paid') {
              // Paid user → show page and keep it visible
              console.log('✅ User has paid subscription, showing download page');
              showPage();
              return;
            }
            
            // User has 'free' subscription tier
            if (profile.onboarding_complete) {
              // Completed onboarding but not paid → redirect to paywall
              console.log('User completed onboarding but not paid. Redirecting to paywall.');
              window.location.href = window.location.origin + '/onboarding-paywall.html';
              return;
            } else {
              // Not completed onboarding → redirect to onboarding start
              console.log('User has not completed onboarding. Redirecting to onboarding page.');
              window.location.href = window.location.origin + '/onboarding.html';
              return;
            }
          } catch (error) {
            console.error('Error in auth guard:', error);
            console.error('Error details:', JSON.stringify(error, null, 2));
            // On error, redirect to signin to be safe
            window.location.href = window.location.origin + '/signin.html';
          }
        })();
        }).catch((error) => {
          console.error('Error in ensureUserProfile promise:', error);
          // If profile check fails, still try to run the auth guard
          (async function() {
            try {
              const { data: { user } } = await supabase.auth.getUser();
              if (user) {
                // Try to check subscription anyway
                const { data: profile } = await supabase
                  .from('profiles')
                  .select('subscription_tier, onboarding_complete')
                  .eq('id', user.id)
                  .single();
                
                if (profile && profile.subscription_tier === 'paid') {
                  console.log('✅ User has paid subscription (fallback check), showing download page');
                  showPage();
                } else if (profile) {
                  // Free user - redirect based on onboarding status
                  if (profile.onboarding_complete) {
                    window.location.href = window.location.origin + '/onboarding-paywall.html';
                  } else {
                    window.location.href = window.location.origin + '/onboarding.html';
                  }
                } else {
                  // No profile - redirect to onboarding
                  window.location.href = window.location.origin + '/onboarding.html';
                }
              } else {
                window.location.href = window.location.origin + '/signin.html';
              }
            } catch (err) {
              console.error('Fallback auth check failed:', err);
              window.location.href = window.location.origin + '/signin.html';
            }
          })();
        });
      });
        const signOutEl = document.getElementById('sign-out');
        if (signOutEl) {
          signOutEl.addEventListener('click', async () => {
            try {
              await supabase.auth.signOut();
            } catch (e) {
              console.error('Error signing out:', e);
            } finally {
              window.location.href = 'index.html';
            }
          });
        }
      });
    });
  </script>
</body>

</html>